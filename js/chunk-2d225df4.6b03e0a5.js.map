{"version":3,"sources":["webpack:///./src/components/redis/LogicalExpire.vue?58e8","webpack:///src/components/redis/LogicalExpire.vue","webpack:///./src/components/redis/LogicalExpire.vue?e0d9","webpack:///./src/components/redis/LogicalExpire.vue"],"names":["render","_vm","this","_h","$createElement","_c","_self","staticClass","attrs","scopedSlots","_u","key","fn","_v","proxy","staticRenderFns","name","components","CodeContainer","component"],"mappings":"uHAAA,IAAIA,EAAS,WAAa,IAAIC,EAAIC,KAASC,EAAGF,EAAIG,eAAmBC,EAAGJ,EAAIK,MAAMD,IAAIF,EAAG,OAAOE,EAAG,MAAM,CAACA,EAAG,MAAM,CAACE,YAAY,WAAW,CAACF,EAAG,MAAM,CAACE,YAAY,mBAAmB,CAACF,EAAG,gBAAgB,CAACG,MAAM,CAAC,MAAQ,IAAIC,YAAYR,EAAIS,GAAG,CAAC,CAACC,IAAI,aAAaC,GAAG,WAAW,MAAO,CAACP,EAAG,MAAM,CAACJ,EAAIY,GAAG,qzDAA6zDC,OAAM,OAAUT,EAAG,gBAAgB,CAACG,MAAM,CAAC,MAAQ,UAAUC,YAAYR,EAAIS,GAAG,CAAC,CAACC,IAAI,aAAaC,GAAG,WAAW,MAAO,CAACP,EAAG,MAAM,CAACJ,EAAIY,GAAG,kGAAkGC,OAAM,OAAUT,EAAG,gBAAgB,CAACG,MAAM,CAAC,MAAQ,aAAaC,YAAYR,EAAIS,GAAG,CAAC,CAACC,IAAI,aAAaC,GAAG,WAAW,MAAO,CAACP,EAAG,MAAM,CAACJ,EAAIY,GAAG,kHAAkHC,OAAM,QAAW,QAC/lFC,EAAkB,G,YCsFP,GACfC,qBACAC,YACAC,uBC1FsW,I,YCOlWC,EAAY,eACd,EACAnB,EACAe,GACA,EACA,KACA,KACA,MAIa,aAAAI,E","file":"js/chunk-2d225df4.6b03e0a5.js","sourcesContent":["var render = function () {var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c('div',[_c('div',{staticClass:\"row m-4\"},[_c('div',{staticClass:\"col-md-8 col-12\"},[_c('CodeContainer',{attrs:{\"title\":''},scopedSlots:_vm._u([{key:\"sourceCode\",fn:function(){return [_c('pre',[_vm._v(\"Random random = new Random();\\nSupplier<Person> supplier = () -> {\\n  Person person = new Person(); // select from db\\n  person.setName(\\\"Tom\\\" + random.nextInt(10));\\n  person.setAge(random.nextInt(99));\\n  return person;\\n};\\nPerson person = queryWithLogicalExpire(\\\"person\\\", Person.class, supplier);\\n\\npublic void setWithLogicalExpire(String key, Object value, Long time, TimeUnit unit) {\\n    RedisData redisData = new RedisData();\\n    redisData.setData(value);\\n    redisData.setExpireTime(LocalDateTime.now().plusSeconds(unit.toSeconds(time)));\\n    stringRedisTemplate.opsForValue().set(key, gson.toJson(redisData));\\n}\\n\\npublic <E> E queryWithLogicalExpire(String key, Class<E> type, Supplier<E> supplier) {\\n    String json = stringRedisTemplate.opsForValue().get(key);\\n    RedisData redisData = gson.fromJson(json, RedisData.class);\\n    E data = gson.fromJson(gson.toJson(redisData.getData()), type);\\n    if (redisData.getExpireTime().isAfter(LocalDateTime.now())) {\\n        // 尚未過期\\n        return data;\\n    }\\n    String lockKey = \\\"lock\\\";\\n    boolean isLock = getLock(lockKey);\\n    if (isLock) {\\n        ExecutorService executorService = Executors.newSingleThreadExecutor();\\n        executorService.submit(() -> {\\n            try {\\n                E e = supplier.get();\\n                setWithLogicalExpire(key, e, 2L, TimeUnit.MINUTES);\\n            } catch (Exception e) {\\n                e.printStackTrace();\\n            } finally {\\n                removeLock(lockKey);\\n            }\\n        });\\n    }\\n    return data;\\n}\\n\\nprivate boolean getLock(String key) {\\n    Boolean isLock = stringRedisTemplate.opsForValue().setIfAbsent(key, \\\"1\\\", 10, TimeUnit.SECONDS);\\n    return Boolean.TRUE.equals(isLock);\\n}\\n\\nprivate void removeLock(String key) {\\n    stringRedisTemplate.delete(key);\\n}\\n            \")])]},proxy:true}])}),_c('CodeContainer',{attrs:{\"title\":'Person'},scopedSlots:_vm._u([{key:\"sourceCode\",fn:function(){return [_c('pre',[_vm._v(\"public class Person {\\n    private String name;\\n    private Integer age;\\n}\\n            \")])]},proxy:true}])}),_c('CodeContainer',{attrs:{\"title\":'RedisData'},scopedSlots:_vm._u([{key:\"sourceCode\",fn:function(){return [_c('pre',[_vm._v(\"public class RedisData {\\n    private Object data;\\n    private LocalDateTime expireTime;\\n}\\n            \")])]},proxy:true}])})],1)])])}\nvar staticRenderFns = []\n\nexport { render, staticRenderFns }","<template>\r\n  <div>\r\n    <div class=\"row m-4\">\r\n      <div class=\"col-md-8 col-12\">\r\n        <CodeContainer :title=\"''\">\r\n          <template v-slot:sourceCode>\r\n            <pre>\r\nRandom random = new Random();\r\nSupplier&lt;Person&gt; supplier = () -> {\r\n  Person person = new Person(); // select from db\r\n  person.setName(\"Tom\" + random.nextInt(10));\r\n  person.setAge(random.nextInt(99));\r\n  return person;\r\n};\r\nPerson person = queryWithLogicalExpire(\"person\", Person.class, supplier);\r\n\r\npublic void setWithLogicalExpire(String key, Object value, Long time, TimeUnit unit) {\r\n    RedisData redisData = new RedisData();\r\n    redisData.setData(value);\r\n    redisData.setExpireTime(LocalDateTime.now().plusSeconds(unit.toSeconds(time)));\r\n    stringRedisTemplate.opsForValue().set(key, gson.toJson(redisData));\r\n}\r\n\r\npublic &lt;E&gt; E queryWithLogicalExpire(String key, Class&lt;E&gt; type, Supplier&lt;E&gt; supplier) {\r\n    String json = stringRedisTemplate.opsForValue().get(key);\r\n    RedisData redisData = gson.fromJson(json, RedisData.class);\r\n    E data = gson.fromJson(gson.toJson(redisData.getData()), type);\r\n    if (redisData.getExpireTime().isAfter(LocalDateTime.now())) {\r\n        // 尚未過期\r\n        return data;\r\n    }\r\n    String lockKey = \"lock\";\r\n    boolean isLock = getLock(lockKey);\r\n    if (isLock) {\r\n        ExecutorService executorService = Executors.newSingleThreadExecutor();\r\n        executorService.submit(() -> {\r\n            try {\r\n                E e = supplier.get();\r\n                setWithLogicalExpire(key, e, 2L, TimeUnit.MINUTES);\r\n            } catch (Exception e) {\r\n                e.printStackTrace();\r\n            } finally {\r\n                removeLock(lockKey);\r\n            }\r\n        });\r\n    }\r\n    return data;\r\n}\r\n\r\nprivate boolean getLock(String key) {\r\n    Boolean isLock = stringRedisTemplate.opsForValue().setIfAbsent(key, \"1\", 10, TimeUnit.SECONDS);\r\n    return Boolean.TRUE.equals(isLock);\r\n}\r\n\r\nprivate void removeLock(String key) {\r\n    stringRedisTemplate.delete(key);\r\n}\r\n            </pre>\r\n          </template>\r\n        </CodeContainer>\r\n        <CodeContainer :title=\"'Person'\">\r\n          <template v-slot:sourceCode>\r\n            <pre>\r\npublic class Person {\r\n    private String name;\r\n    private Integer age;\r\n}\r\n            </pre>\r\n          </template>\r\n        </CodeContainer>\r\n        <CodeContainer :title=\"'RedisData'\">\r\n          <template v-slot:sourceCode>\r\n            <pre>\r\npublic class RedisData {\r\n    private Object data;\r\n    private LocalDateTime expireTime;\r\n}\r\n            </pre>\r\n          </template>\r\n        </CodeContainer>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport CodeContainer from \"@/components/shared/CodeContainer.vue\";\r\nexport default {\r\n  name: \"LogicalExpire\",\r\n  components: {\r\n    CodeContainer,\r\n  },\r\n};\r\n</script>\r\n","import mod from \"-!../../../node_modules/cache-loader/dist/cjs.js??ref--13-0!../../../node_modules/thread-loader/dist/cjs.js!../../../node_modules/babel-loader/lib/index.js!../../../node_modules/cache-loader/dist/cjs.js??ref--1-0!../../../node_modules/vue-loader/lib/index.js??vue-loader-options!./LogicalExpire.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../../node_modules/cache-loader/dist/cjs.js??ref--13-0!../../../node_modules/thread-loader/dist/cjs.js!../../../node_modules/babel-loader/lib/index.js!../../../node_modules/cache-loader/dist/cjs.js??ref--1-0!../../../node_modules/vue-loader/lib/index.js??vue-loader-options!./LogicalExpire.vue?vue&type=script&lang=js&\"","import { render, staticRenderFns } from \"./LogicalExpire.vue?vue&type=template&id=0be1fe1e&\"\nimport script from \"./LogicalExpire.vue?vue&type=script&lang=js&\"\nexport * from \"./LogicalExpire.vue?vue&type=script&lang=js&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../../node_modules/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  null,\n  null\n  \n)\n\nexport default component.exports"],"sourceRoot":""}