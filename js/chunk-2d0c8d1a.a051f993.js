(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2d0c8d1a"],{5702:function(e,n,t){"use strict";t.r(n);var r=function(){var e=this,n=e.$createElement,t=e._self._c||n;return t("div",[t("div",{staticClass:"row m-4"},[t("div",{staticClass:"col-md-8 col-12"},[t("CodeContainer",{attrs:{title:""},scopedSlots:e._u([{key:"sourceCode",fn:function(){return[t("pre",[e._v('boolean isLock = tryLock(lockKey);\n// 取鎖失敗\nif (!isLock) {\n    return Result.fail("1個人只許下1單");\n}\n// 取鎖成功\ntry {\n    IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();\n    return proxy.createVoucherOrder(voucherId);\n} finally {\n    // 釋放鎖\n    lock.unlock();\n}\n\n-------------------------------------------------------------------------------------------------------------------------\n// 嘗試獲取鎖\npublic boolean tryLock(String key, long timeoutSec) {\n    String threadId = ID_PREFIX + Thread.currentThread().getId();\n    Boolean success = stringRedisTemplate.opsForValue().setIfAbsent(key, threadId, timeoutSec, TimeUnit.SECONDS);\n    return Boolean.TRUE.equals(success);\n}\n\n// redis解鎖\npublic void unlock() {\n    // 取得線程標示\n    String threadId = ID_PREFIX + Thread.currentThread().getId();\n    // 取得鎖的value\n    String id = stringRedisTemplate.opsForValue().get(KEY_PREFIX + name);\n    // 釋放鎖\n    if (threadId.equals(id)) {\n        stringRedisTemplate.delete(KEY_PREFIX + name);\n    }\n}\n\n// lua解鎖\npublic void unlock() {\n    List<String> keys = Collections.singletonList(KEY_PREFIX + name);\n    String threadId = ID_PREFIX + Thread.currentThread().getId();\n    stringRedisTemplate.execute(UNLOCK_SCRIPT, keys, threadId);\n}\n            ')])]},proxy:!0}])})],1)])])},o=[],i=t("32f4"),c={name:"Lock",components:{CodeContainer:i["a"]}},a=c,s=t("2877"),d=Object(s["a"])(a,r,o,!1,null,null,null);n["default"]=d.exports}}]);
//# sourceMappingURL=chunk-2d0c8d1a.a051f993.js.map